{"version":3,"sources":["../../src/vlm/cost-tracker.ts","../../src/vlm/cursor-bridge.ts","../../src/vlm/client.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * @flowsight/desktop-test - VLM Cost Tracker\n *\n * Tracks API usage and estimates costs across different VLM providers.\n */\n\nimport {\n  VLMProvider,\n  type CostEntry,\n  type CostSummary,\n} from '../types.js';\n\n/**\n * Pricing information per provider (as of 2024)\n * Prices in USD per unit\n */\nconst PRICING: Record<string, {\n  inputTokenPrice: number;      // per 1K tokens\n  outputTokenPrice: number;     // per 1K tokens\n  imagePrice: number;           // per image\n}> = {\n  [VLMProvider.ANTHROPIC]: {\n    inputTokenPrice: 0.003,     // Claude 3.5 Sonnet\n    outputTokenPrice: 0.015,\n    imagePrice: 0.0048,         // ~1280x1280 image\n  },\n  [VLMProvider.OPENAI]: {\n    inputTokenPrice: 0.005,     // GPT-4o\n    outputTokenPrice: 0.015,\n    imagePrice: 0.00765,        // high detail\n  },\n  [VLMProvider.VOLCENGINE]: {\n    inputTokenPrice: 0.0008,    // Doubao Pro (Chinese pricing)\n    outputTokenPrice: 0.002,\n    imagePrice: 0.001,\n  },\n  [VLMProvider.DOUBAO]: {\n    inputTokenPrice: 0.0008,\n    outputTokenPrice: 0.002,\n    imagePrice: 0.001,\n  },\n  // Default/fallback pricing\n  default: {\n    inputTokenPrice: 0.003,\n    outputTokenPrice: 0.015,\n    imagePrice: 0.005,\n  },\n};\n\n/**\n * Cost Tracker - monitors VLM API usage and costs\n */\nexport class CostTracker {\n  private entries: CostEntry[] = [];\n  private customPricing: Record<string, typeof PRICING[string]> = {};\n\n  /**\n   * Set custom pricing for a provider\n   */\n  setPricing(provider: string, pricing: typeof PRICING[string]): void {\n    this.customPricing[provider] = pricing;\n  }\n\n  /**\n   * Get pricing for a provider\n   */\n  private getPricing(provider: string): typeof PRICING[string] {\n    return this.customPricing[provider] || PRICING[provider] || PRICING.default;\n  }\n\n  /**\n   * Track a VLM API call\n   */\n  track(entry: {\n    provider: VLMProvider | string;\n    model: string;\n    inputTokens: number;\n    outputTokens: number;\n    images?: number;\n    operation: CostEntry['operation'];\n  }): CostEntry {\n    const pricing = this.getPricing(entry.provider);\n    const images = entry.images || 1;\n\n    const cost =\n      (entry.inputTokens / 1000) * pricing.inputTokenPrice +\n      (entry.outputTokens / 1000) * pricing.outputTokenPrice +\n      images * pricing.imagePrice;\n\n    const costEntry: CostEntry = {\n      provider: entry.provider,\n      model: entry.model,\n      inputTokens: entry.inputTokens,\n      outputTokens: entry.outputTokens,\n      images,\n      cost,\n      timestamp: Date.now(),\n      operation: entry.operation,\n    };\n\n    this.entries.push(costEntry);\n    return costEntry;\n  }\n\n  /**\n   * Estimate cost for a potential call (without tracking)\n   */\n  estimate(entry: {\n    provider: VLMProvider | string;\n    inputTokens: number;\n    outputTokens: number;\n    images?: number;\n  }): number {\n    const pricing = this.getPricing(entry.provider);\n    const images = entry.images || 1;\n\n    return (\n      (entry.inputTokens / 1000) * pricing.inputTokenPrice +\n      (entry.outputTokens / 1000) * pricing.outputTokenPrice +\n      images * pricing.imagePrice\n    );\n  }\n\n  /**\n   * Get cost summary\n   */\n  getSummary(): CostSummary {\n    const byProvider: Record<string, number> = {};\n    const byOperation: Record<string, number> = {};\n\n    for (const entry of this.entries) {\n      byProvider[entry.provider] = (byProvider[entry.provider] || 0) + entry.cost;\n      byOperation[entry.operation] = (byOperation[entry.operation] || 0) + entry.cost;\n    }\n\n    return {\n      totalCost: this.entries.reduce((sum, e) => sum + e.cost, 0),\n      totalCalls: this.entries.length,\n      byProvider,\n      byOperation,\n      entries: [...this.entries],\n    };\n  }\n\n  /**\n   * Get recent entries\n   */\n  getRecentEntries(count: number = 10): CostEntry[] {\n    return this.entries.slice(-count);\n  }\n\n  /**\n   * Reset tracking\n   */\n  reset(): void {\n    this.entries = [];\n  }\n\n  /**\n   * Export to JSON\n   */\n  toJSON(): string {\n    return JSON.stringify(this.getSummary(), null, 2);\n  }\n\n  /**\n   * Print summary to console\n   */\n  printSummary(): void {\n    const summary = this.getSummary();\n\n    console.log('\\n=== VLM Cost Summary ===');\n    console.log(`Total Cost: $${summary.totalCost.toFixed(4)}`);\n    console.log(`Total Calls: ${summary.totalCalls}`);\n\n    if (Object.keys(summary.byProvider).length > 0) {\n      console.log('\\nBy Provider:');\n      for (const [provider, cost] of Object.entries(summary.byProvider)) {\n        console.log(`  ${provider}: $${cost.toFixed(4)}`);\n      }\n    }\n\n    if (Object.keys(summary.byOperation).length > 0) {\n      console.log('\\nBy Operation:');\n      for (const [operation, cost] of Object.entries(summary.byOperation)) {\n        console.log(`  ${operation}: $${cost.toFixed(4)}`);\n      }\n    }\n\n    console.log('========================\\n');\n  }\n}\n","/**\n * @flowsight/desktop-test - Cursor Bridge\n *\n * Enables VLM functionality using Cursor's built-in Claude model.\n * When tests run within a Cursor Agent context, visual analysis\n * requests are automatically processed by the current Claude session.\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport type {\n  VLMConfig,\n  VLMFindRequest,\n  VLMFindResponse,\n  VLMActionRequest,\n  VLMActionResponse,\n  VLMAssertRequest,\n  VLMAssertResponse,\n  CostSummary,\n} from '../types.js';\n\n/**\n * Detected Claude Agent environment\n */\nexport type AgentEnvironment = \n  | 'cursor'           // Cursor IDE\n  | 'claude-code'      // Claude Code CLI (terminal)\n  | 'vscode-claude'    // VSCode Claude plugin\n  | 'claude-desktop'   // Claude Desktop app\n  | 'anthropic-mcp'    // Generic MCP environment\n  | 'unknown';         // Unknown but likely agent context\n\n/**\n * Detect which Claude Agent environment we're running in\n */\nexport function detectAgentEnvironment(): AgentEnvironment | null {\n  // 1. Cursor IDE\n  if (\n    process.env.CURSOR_SESSION ||\n    process.env.CURSOR_WORKSPACE ||\n    process.env.CURSOR_IDE ||\n    process.env.CURSOR_TRACE_ID\n  ) {\n    return 'cursor';\n  }\n\n  // 2. Claude Code CLI (terminal)\n  if (\n    process.env.CLAUDE_CODE ||\n    process.env.CLAUDE_CLI ||\n    process.env.ANTHROPIC_AGENT ||\n    process.env.CLAUDE_SESSION_ID\n  ) {\n    return 'claude-code';\n  }\n\n  // 3. VSCode Claude plugin\n  if (\n    process.env.VSCODE_CLAUDE ||\n    process.env.CLAUDE_VSCODE ||\n    process.env.VSCODE_PID && process.env.ANTHROPIC_API_KEY === undefined\n  ) {\n    return 'vscode-claude';\n  }\n\n  // 4. Claude Desktop app\n  if (\n    process.env.CLAUDE_DESKTOP ||\n    process.env.CLAUDE_APP\n  ) {\n    return 'claude-desktop';\n  }\n\n  // 5. Generic MCP environment\n  if (\n    process.env.MCP_SERVER ||\n    process.env.MCP_SESSION\n  ) {\n    return 'anthropic-mcp';\n  }\n\n  // 6. Check if running in TTY with common agent indicators\n  if (\n    process.stdout.isTTY === false &&\n    (process.env.TERM_PROGRAM === 'vscode' || \n     process.env.TERM === 'xterm-256color')\n  ) {\n    return 'unknown';\n  }\n\n  // 7. Explicit flag from user\n  if (process.env.USE_AGENT_MODE === 'true') {\n    return 'unknown';\n  }\n\n  return null;\n}\n\n/**\n * Check if we should use Agent mode (any Claude environment)\n */\nexport function shouldUseAgentMode(): boolean {\n  return detectAgentEnvironment() !== null || \n         process.env.USE_CURSOR === 'true' ||\n         process.env.USE_AGENT_MODE === 'true';\n}\n\n/**\n * Agent Bridge - Works with any Claude Agent environment\n * \n * Supports:\n * - Cursor IDE\n * - Claude Code CLI (terminal)\n * - VSCode Claude plugin\n * - Claude Desktop\n * - Any MCP-enabled environment\n *\n * This bridge outputs structured requests that the Agent processes,\n * using the model available in the current session.\n */\nexport class CursorBridge {\n  private screenshotDir: string;\n  private requestCount = 0;\n  private environment: AgentEnvironment;\n\n  constructor(_config: VLMConfig) {\n    this.environment = detectAgentEnvironment() || 'unknown';\n    this.screenshotDir = path.join(process.cwd(), '.agent-test-screenshots');\n\n    // Ensure screenshot directory exists\n    if (!fs.existsSync(this.screenshotDir)) {\n      fs.mkdirSync(this.screenshotDir, { recursive: true });\n    }\n\n    // Log detected environment\n    console.log(`ü§ñ Agent Bridge initialized (environment: ${this.environment})`);\n  }\n\n  /**\n   * Get the detected agent environment\n   */\n  getEnvironment(): AgentEnvironment {\n    return this.environment;\n  }\n\n  /**\n   * Save screenshot and return path\n   */\n  private saveScreenshot(base64Data: string): string {\n    this.requestCount++;\n    const filename = `screenshot_${Date.now()}_${this.requestCount}.png`;\n    const filepath = path.join(this.screenshotDir, filename);\n\n    // Remove data URL prefix if present\n    const cleanData = base64Data.replace(/^data:image\\/\\w+;base64,/, '');\n    fs.writeFileSync(filepath, Buffer.from(cleanData, 'base64'));\n\n    return filepath;\n  }\n\n  /**\n   * Find element using Cursor's Claude\n   */\n  async findElement(request: VLMFindRequest): Promise<VLMFindResponse> {\n    const screenshotPath = this.saveScreenshot(request.screenshot);\n\n    // Create analysis request file for Agent to process\n    const analysisRequest = {\n      type: 'find_element',\n      screenshot: screenshotPath,\n      description: request.description,\n      context: request.context,\n      timestamp: new Date().toISOString(),\n    };\n\n    const requestFile = path.join(\n      this.screenshotDir,\n      `request_${Date.now()}.json`\n    );\n    fs.writeFileSync(requestFile, JSON.stringify(analysisRequest, null, 2));\n\n    // Output for Agent processing\n    console.log('\\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');\n    console.log('‚îÇ üîç CURSOR VLM REQUEST: Find Element                     ‚îÇ');\n    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');\n    console.log(`‚îÇ Screenshot: ${screenshotPath}`);\n    console.log(`‚îÇ Target: \"${request.description}\"`);\n    if (request.context) {\n      console.log(`‚îÇ Context: ${request.context}`);\n    }\n    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');\n    console.log('‚îÇ Please analyze the screenshot and provide coordinates   ‚îÇ');\n    console.log('‚îÇ or set CURSOR_VLM_RESPONSE env var with JSON response   ‚îÇ');\n    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\\n');\n\n    // Check for pre-set response (for automated scenarios)\n    if (process.env.CURSOR_VLM_RESPONSE) {\n      try {\n        const response = JSON.parse(process.env.CURSOR_VLM_RESPONSE);\n        delete process.env.CURSOR_VLM_RESPONSE;\n        return response as VLMFindResponse;\n      } catch {\n        // Continue with default response\n      }\n    }\n\n    // Check for response file\n    const responseFile = requestFile.replace('request_', 'response_');\n    if (fs.existsSync(responseFile)) {\n      const response = JSON.parse(fs.readFileSync(responseFile, 'utf-8'));\n      return response as VLMFindResponse;\n    }\n\n    // Default: return not found (Agent should intercept and handle)\n    return {\n      confidence: 0,\n      reasoning: 'Waiting for Cursor Agent to analyze screenshot',\n      notFound: true,\n      alternative: 'Use MCP browser tools or provide manual coordinates',\n    };\n  }\n\n  /**\n   * Get next action using Cursor's Claude\n   */\n  async getNextAction(request: VLMActionRequest): Promise<VLMActionResponse> {\n    const screenshotPath = this.saveScreenshot(request.screenshot);\n\n    // Output structured request\n    console.log('\\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');\n    console.log('‚îÇ üéØ CURSOR VLM REQUEST: Get Next Action                  ‚îÇ');\n    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');\n    console.log(`‚îÇ Screenshot: ${screenshotPath}`);\n    console.log(`‚îÇ Instruction: \"${request.instruction}\"`);\n    console.log('‚îÇ Available Actions:');\n    request.actionSpaces.slice(0, 5).forEach((action) => {\n      console.log(`‚îÇ   - ${action}`);\n    });\n    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\\n');\n\n    // Check for pre-set response\n    if (process.env.CURSOR_VLM_RESPONSE) {\n      try {\n        const response = JSON.parse(process.env.CURSOR_VLM_RESPONSE);\n        delete process.env.CURSOR_VLM_RESPONSE;\n        return response as VLMActionResponse;\n      } catch {\n        // Continue\n      }\n    }\n\n    return {\n      actionType: 'wait',\n      actionParams: {},\n      thought: 'Waiting for Cursor Agent to provide action',\n      finished: false,\n    };\n  }\n\n  /**\n   * Visual assertion using Cursor's Claude\n   */\n  async assertVisual(request: VLMAssertRequest): Promise<VLMAssertResponse> {\n    const screenshotPath = this.saveScreenshot(request.screenshot);\n\n    // Output structured request\n    console.log('\\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');\n    console.log('‚îÇ ‚úÖ CURSOR VLM REQUEST: Visual Assertion                 ‚îÇ');\n    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');\n    console.log(`‚îÇ Screenshot: ${screenshotPath}`);\n    console.log(`‚îÇ Assertion: \"${request.assertion}\"`);\n    if (request.expected) {\n      console.log(`‚îÇ Expected: ${request.expected}`);\n    }\n    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');\n    console.log('‚îÇ Please verify the assertion and respond with:           ‚îÇ');\n    console.log('‚îÇ { \"passed\": true/false, \"reasoning\": \"...\", \"actual\": \"...\" }');\n    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\\n');\n\n    // Check for pre-set response\n    if (process.env.CURSOR_VLM_RESPONSE) {\n      try {\n        const response = JSON.parse(process.env.CURSOR_VLM_RESPONSE);\n        delete process.env.CURSOR_VLM_RESPONSE;\n        return response as VLMAssertResponse;\n      } catch {\n        // Continue\n      }\n    }\n\n    // For automated testing, try to use simple heuristics\n    // In real usage, the Cursor Agent should intercept and handle\n    return {\n      passed: false,\n      reasoning: 'Waiting for Cursor Agent to verify assertion',\n      actual: 'Pending verification',\n    };\n  }\n\n  /**\n   * Get cost summary (Cursor mode is free - uses existing subscription)\n   */\n  getCostSummary(): CostSummary {\n    return {\n      totalCost: 0, // Cursor mode is free (uses existing subscription)\n      totalCalls: this.requestCount,\n      byProvider: { cursor: 0 },\n      byOperation: { find: 0, action: 0, assert: 0 },\n      entries: [],\n    };\n  }\n}\n\n/**\n * Create an automated Cursor VLM handler for use in Agent context\n *\n * This function can be called by the Cursor Agent to process VLM requests\n * that were output by the test framework.\n */\nexport async function handleCursorVLMRequest(\n  requestPath: string,\n  analyzeImage: (imagePath: string, prompt: string) => Promise<string>\n): Promise<void> {\n  if (!fs.existsSync(requestPath)) {\n    throw new Error(`Request file not found: ${requestPath}`);\n  }\n\n  const request = JSON.parse(fs.readFileSync(requestPath, 'utf-8'));\n  const responsePath = requestPath.replace('request_', 'response_');\n\n  let response: VLMFindResponse | VLMActionResponse | VLMAssertResponse;\n\n  switch (request.type) {\n    case 'find_element': {\n      const prompt = `Look at this screenshot and find the element described as: \"${request.description}\"\n${request.context ? `Context: ${request.context}` : ''}\n\nReturn a JSON object with:\n- coordinates: { x: number, y: number } - the center point of the element\n- confidence: number (0-1) - how confident you are\n- reasoning: string - explanation\n- notFound: boolean - true if element cannot be found`;\n\n      const result = await analyzeImage(request.screenshot, prompt);\n      response = JSON.parse(result) as VLMFindResponse;\n      break;\n    }\n\n    case 'get_action': {\n      const prompt = `Look at this screenshot and determine the next action for: \"${request.instruction}\"\n\nAvailable actions: ${request.actionSpaces?.join(', ')}\n\nReturn a JSON object with:\n- actionType: string\n- actionParams: object\n- thought: string\n- finished: boolean`;\n\n      const result = await analyzeImage(request.screenshot, prompt);\n      response = JSON.parse(result) as VLMActionResponse;\n      break;\n    }\n\n    case 'assert_visual': {\n      const prompt = `Look at this screenshot and verify: \"${request.assertion}\"\n${request.expected ? `Expected: ${request.expected}` : ''}\n\nReturn a JSON object with:\n- passed: boolean\n- reasoning: string\n- actual: string (what you actually observed)`;\n\n      const result = await analyzeImage(request.screenshot, prompt);\n      response = JSON.parse(result) as VLMAssertResponse;\n      break;\n    }\n\n    default:\n      throw new Error(`Unknown request type: ${request.type}`);\n  }\n\n  fs.writeFileSync(responsePath, JSON.stringify(response, null, 2));\n  console.log(`‚úì Response written to: ${responsePath}`);\n}\n","/**\n * @flowsight/desktop-test - VLM Client\n *\n * Unified client for Vision-Language Models (Claude, GPT-4V, Doubao, etc.)\n * Used for visual element finding and intelligent UI understanding.\n */\n\nimport {\n  VLMProvider,\n  type VLMConfig,\n  type VLMFindRequest,\n  type VLMFindResponse,\n  type VLMActionRequest,\n  type VLMActionResponse,\n  type VLMAssertRequest,\n  type VLMAssertResponse,\n  type CostSummary,\n  type VLMClientInterface,\n} from '../types.js';\n\nimport { CostTracker } from './cost-tracker.js';\nimport { CursorBridge, shouldUseAgentMode, detectAgentEnvironment } from './cursor-bridge.js';\n\n/**\n * Default models for each provider\n */\nconst DEFAULT_MODELS: Record<string, string> = {\n  [VLMProvider.ANTHROPIC]: 'claude-sonnet-4-20250514',\n  [VLMProvider.OPENAI]: 'gpt-4o',\n  [VLMProvider.VOLCENGINE]: 'doubao-1-5-vision-pro',\n  [VLMProvider.DOUBAO]: 'doubao-1-5-vision-pro',\n  [VLMProvider.CURSOR]: 'claude-opus-4-5', // Uses Cursor's built-in model\n};\n\n/**\n * VLM Client - provides unified access to various VLM providers\n */\nexport class VLMClient implements VLMClientInterface {\n  private config: VLMConfig;\n  private provider: VLMProvider;\n  private model: string;\n  private costTracker: CostTracker;\n  private cursorBridge?: CursorBridge;\n\n  constructor(config: VLMConfig) {\n    this.config = config;\n    this.provider = this.normalizeProvider(config.provider);\n    this.model = config.model || DEFAULT_MODELS[this.provider] || 'gpt-4o';\n    this.costTracker = new CostTracker();\n\n    // Auto-detect agent environment if no API key provided\n    const shouldAutoUseAgent = \n      this.provider === VLMProvider.CURSOR ||\n      (shouldUseAgentMode() && !config.apiKey && !process.env.ANTHROPIC_API_KEY && !process.env.OPENAI_API_KEY);\n\n    if (shouldAutoUseAgent) {\n      this.cursorBridge = new CursorBridge(config);\n      this.provider = VLMProvider.CURSOR;\n      \n      const env = detectAgentEnvironment();\n      if (env && env !== 'cursor') {\n        console.log(`üìç Auto-detected ${env} environment, using Agent mode`);\n      }\n    }\n  }\n\n  /**\n   * Check if using Agent mode\n   */\n  isUsingAgentMode(): boolean {\n    return this.cursorBridge !== undefined;\n  }\n\n  /**\n   * Get detected agent environment\n   */\n  getAgentEnvironment(): string | null {\n    return this.cursorBridge?.getEnvironment() || null;\n  }\n\n  private normalizeProvider(provider: VLMProvider | string): VLMProvider {\n    if (typeof provider === 'string') {\n      const normalized = provider.toLowerCase();\n      if (normalized === 'anthropic' || normalized === 'claude') {\n        return VLMProvider.ANTHROPIC;\n      }\n      if (normalized === 'openai' || normalized === 'gpt') {\n        return VLMProvider.OPENAI;\n      }\n      if (normalized === 'volcengine' || normalized === 'volc') {\n        return VLMProvider.VOLCENGINE;\n      }\n      if (normalized === 'doubao') {\n        return VLMProvider.DOUBAO;\n      }\n      if (normalized === 'cursor') {\n        return VLMProvider.CURSOR;\n      }\n      // 'agent' or 'auto' - auto-detect any Claude environment\n      if (normalized === 'agent' || normalized === 'auto') {\n        return VLMProvider.CURSOR; // Will use CursorBridge for all agent environments\n      }\n      return VLMProvider.CUSTOM;\n    }\n    return provider;\n  }\n\n  /**\n   * Find element by visual description\n   */\n  async findElement(request: VLMFindRequest): Promise<VLMFindResponse> {\n    // Use Cursor bridge if configured\n    if (this.cursorBridge) {\n      return this.cursorBridge.findElement(request);\n    }\n\n    const systemPrompt = `You are a GUI automation assistant. Your task is to find UI elements in screenshots.\n\nGiven a screenshot and an element description, you need to:\n1. Locate the described element in the screenshot\n2. Return the center coordinates (x, y) of the element\n3. Provide your confidence level (0-1)\n4. Explain your reasoning\n\nIf the element cannot be found, set notFound to true and suggest alternatives.\n\nIMPORTANT: Return coordinates in the format that can be used for clicking.\nThe screenshot dimensions will be provided.`;\n\n    const userPrompt = `Find the following element in the screenshot:\n\"${request.description}\"\n\n${request.context ? `Context: ${request.context}` : ''}\n\nReturn a JSON object with:\n- coordinates: { x: number, y: number } or null if not found\n- confidence: number (0-1)\n- reasoning: string\n- notFound: boolean\n- alternative: string (if not found, suggest what similar element exists)`;\n\n    const response = await this.callVLM(systemPrompt, userPrompt, request.screenshot, 'find');\n\n    try {\n      const parsed = this.parseJSON(response);\n      const coordinates = parsed.coordinates as { x: number; y: number } | undefined;\n      return {\n        coordinates,\n        confidence: (parsed.confidence as number) || 0,\n        reasoning: (parsed.reasoning as string) || '',\n        notFound: (parsed.notFound as boolean) || !coordinates,\n        alternative: parsed.alternative as string | undefined,\n      };\n    } catch {\n      return {\n        confidence: 0,\n        reasoning: 'Failed to parse VLM response',\n        notFound: true,\n      };\n    }\n  }\n\n  /**\n   * Get next action to perform\n   */\n  async getNextAction(request: VLMActionRequest): Promise<VLMActionResponse> {\n    // Use Cursor bridge if configured\n    if (this.cursorBridge) {\n      return this.cursorBridge.getNextAction(request);\n    }\n\n    const systemPrompt = `You are a GUI automation agent. Your task is to control a desktop application to complete user instructions.\n\nAvailable actions:\n${request.actionSpaces.join('\\n')}\n\nFor each step:\n1. Analyze the current screenshot\n2. Decide the best action to take\n3. Return the action with parameters\n\nWhen the task is complete, return finished: true.\n\nIMPORTANT: \n- Think step by step\n- Only perform one action at a time\n- Be precise with coordinates`;\n\n    const userPrompt = `Instruction: \"${request.instruction}\"\n\nBased on the current screenshot, what action should be taken next?\n\nReturn a JSON object with:\n- actionType: string (one of the available actions)\n- actionParams: object (parameters for the action)\n- thought: string (your reasoning)\n- reflection: string (any observations)\n- finished: boolean (true if task is complete)`;\n\n    const response = await this.callVLM(systemPrompt, userPrompt, request.screenshot, 'action');\n\n    try {\n      const parsed = this.parseJSON(response);\n      return {\n        actionType: (parsed.actionType as string) || 'wait',\n        actionParams: (parsed.actionParams as Record<string, unknown>) || {},\n        thought: (parsed.thought as string) || '',\n        reflection: parsed.reflection as string | undefined,\n        finished: (parsed.finished as boolean) || false,\n      };\n    } catch {\n      return {\n        actionType: 'wait',\n        actionParams: {},\n        thought: 'Failed to parse VLM response',\n        finished: false,\n      };\n    }\n  }\n\n  /**\n   * Perform visual assertion\n   */\n  async assertVisual(request: VLMAssertRequest): Promise<VLMAssertResponse> {\n    // Use Cursor bridge if configured\n    if (this.cursorBridge) {\n      return this.cursorBridge.assertVisual(request);\n    }\n\n    const systemPrompt = `You are a QA automation assistant. Your task is to verify UI states and conditions.\n\nGiven a screenshot and an assertion, you need to:\n1. Analyze the screenshot carefully\n2. Determine if the assertion is true or false\n3. Provide detailed reasoning\n4. If the assertion fails, suggest how to fix it`;\n\n    const userPrompt = `Assertion: \"${request.assertion}\"\n\n${request.expected ? `Expected: ${request.expected}` : ''}\n\nAnalyze the screenshot and verify the assertion.\n\nReturn a JSON object with:\n- passed: boolean\n- reasoning: string (detailed explanation)\n- actual: string (what you actually observed)\n- suggestions: string[] (if failed, how to fix)`;\n\n    const response = await this.callVLM(systemPrompt, userPrompt, request.screenshot, 'assert');\n\n    try {\n      const parsed = this.parseJSON(response);\n      return {\n        passed: (parsed.passed as boolean) || false,\n        reasoning: (parsed.reasoning as string) || '',\n        actual: (parsed.actual as string) || '',\n        suggestions: parsed.suggestions as string[] | undefined,\n      };\n    } catch {\n      return {\n        passed: false,\n        reasoning: 'Failed to parse VLM response',\n        actual: 'Unknown',\n      };\n    }\n  }\n\n  /**\n   * Compare two screenshots and find differences (from Python framework)\n   * Note: Currently uses single image analysis. For true comparison, \n   * both images should be sent to the VLM.\n   */\n  async compareScreenshots(\n    screenshot1: string,\n    _screenshot2: string,\n    context?: string\n  ): Promise<{\n    differences: Array<{ type: string; description: string; severity: string }>;\n    summary: string;\n    similarityScore: number;\n  }> {\n    const systemPrompt = `You are a UI testing assistant. Compare two screenshots and identify all differences.`;\n\n    const userPrompt = `Compare these two screenshots and identify differences.\n${context ? `Context: ${context}` : ''}\n\nReturn a JSON object with:\n- differences: array of { type: \"added|removed|changed|moved\", description: string, severity: \"high|medium|low\" }\n- summary: string (overall summary)\n- similarityScore: number (0-1, how similar they are)`;\n\n    // For this we need to send both images - simplified version\n    const response = await this.callVLM(systemPrompt, userPrompt, screenshot1, 'assert');\n\n    try {\n      const parsed = this.parseJSON(response);\n      return {\n        differences: (parsed.differences as Array<{ type: string; description: string; severity: string }>) || [],\n        summary: (parsed.summary as string) || '',\n        similarityScore: (parsed.similarityScore as number) || 0,\n      };\n    } catch {\n      return {\n        differences: [],\n        summary: 'Failed to parse response',\n        similarityScore: 0,\n      };\n    }\n  }\n\n  /**\n   * Detect visual issues in screenshot (from Python framework)\n   */\n  async detectVisualIssues(screenshot: string): Promise<Array<{\n    type: string;\n    severity: string;\n    description: string;\n    location?: { x: number; y: number; width: number; height: number };\n    suggestion?: string;\n  }>> {\n    const systemPrompt = `You are a UI quality assurance expert. Detect visual issues and UI defects.`;\n\n    const userPrompt = `Analyze this screenshot for visual issues and UI defects.\n\nCheck for:\n1. Text truncation or overflow\n2. Element overlap\n3. Alignment issues\n4. Color contrast problems\n5. Blurry or distorted elements\n6. Inconsistent spacing\n7. Layout errors\n\nReturn a JSON object with:\n{\n  \"issues\": [\n    {\n      \"type\": \"text_truncation|overlap|misalignment|contrast|blur|spacing|layout\",\n      \"severity\": \"critical|high|medium|low\",\n      \"description\": \"description of the issue\",\n      \"location\": {\"x\": 100, \"y\": 200, \"width\": 50, \"height\": 20},\n      \"suggestion\": \"how to fix it\"\n    }\n  ]\n}`;\n\n    const response = await this.callVLM(systemPrompt, userPrompt, screenshot, 'assert');\n\n    try {\n      const parsed = this.parseJSON(response);\n      return (parsed.issues as Array<{\n        type: string;\n        severity: string;\n        description: string;\n        location?: { x: number; y: number; width: number; height: number };\n        suggestion?: string;\n      }>) || [];\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Analyze IDE screenshot with specialized prompts (from Python framework)\n   */\n  async analyzeIDEScreenshot(screenshot: string): Promise<{\n    elements: Array<{\n      elementType: string;\n      text?: string;\n      bounds: { x: number; y: number; width: number; height: number };\n      attributes?: Record<string, unknown>;\n    }>;\n    layoutStructure: {\n      type: string;\n      sidebarWidth?: number;\n      editorArea?: { x: number; y: number; width: number; height: number };\n      panels?: string[];\n    };\n    colorScheme: 'dark' | 'light';\n    issues: string[];\n  }> {\n    const systemPrompt = `You are an IDE interface analysis expert. Analyze IDE screenshots to identify all UI elements.\n\nIDE common element types:\n- menu: Menu bar (File, Edit, View, etc.)\n- sidebar: Sidebar (file tree, outline, etc.)\n- editor: Code editor area\n- tab: Tab pages\n- toolbar: Toolbar\n- statusbar: Status bar\n- panel: Panels (terminal, output, etc.)\n- button: Buttons (run, debug, settings, etc.)\n- icon: Icons\n- input: Input fields, search boxes\n- dropdown: Dropdown menus\n- tooltip: Tooltips`;\n\n    const userPrompt = `Analyze this IDE screenshot and identify all interface elements.\n\nReturn a JSON object with:\n{\n  \"elements\": [\n    {\n      \"elementType\": \"type\",\n      \"text\": \"text content\",\n      \"bounds\": {\"x\": 0, \"y\": 0, \"width\": 100, \"height\": 30},\n      \"attributes\": {\"active\": true, \"collapsed\": false}\n    }\n  ],\n  \"layoutStructure\": {\n    \"type\": \"three-column|two-column|single-column\",\n    \"sidebarWidth\": 250,\n    \"editorArea\": {\"x\": 250, \"y\": 50, \"width\": 800, \"height\": 600},\n    \"panels\": [\"terminal\", \"output\"]\n  },\n  \"colorScheme\": \"dark|light\",\n  \"issues\": []\n}`;\n\n    const response = await this.callVLM(systemPrompt, userPrompt, screenshot, 'find');\n\n    try {\n      const parsed = this.parseJSON(response);\n      return {\n        elements: (parsed.elements as Array<{\n          elementType: string;\n          text?: string;\n          bounds: { x: number; y: number; width: number; height: number };\n          attributes?: Record<string, unknown>;\n        }>) || [],\n        layoutStructure: (parsed.layoutStructure as {\n          type: string;\n          sidebarWidth?: number;\n          editorArea?: { x: number; y: number; width: number; height: number };\n          panels?: string[];\n        }) || { type: 'unknown' },\n        colorScheme: ((parsed.colorScheme as string) === 'light' ? 'light' : 'dark'),\n        issues: (parsed.issues as string[]) || [],\n      };\n    } catch {\n      return {\n        elements: [],\n        layoutStructure: { type: 'unknown' },\n        colorScheme: 'dark',\n        issues: ['Failed to analyze screenshot'],\n      };\n    }\n  }\n\n  /**\n   * Get cost summary\n   */\n  getCostSummary(): CostSummary {\n    // Cursor mode is free (uses existing subscription)\n    if (this.cursorBridge) {\n      return this.cursorBridge.getCostSummary();\n    }\n    return this.costTracker.getSummary();\n  }\n\n  /**\n   * Reset cost tracking\n   */\n  resetCostTracking(): void {\n    this.costTracker.reset();\n  }\n\n  /**\n   * Call the VLM API\n   */\n  private async callVLM(\n    systemPrompt: string,\n    userPrompt: string,\n    screenshot: string,\n    operation: 'find' | 'action' | 'assert' | 'analyze'\n  ): Promise<string> {\n    let response: string;\n    let inputTokens = 0;\n    let outputTokens = 0;\n\n    switch (this.provider) {\n      case VLMProvider.ANTHROPIC:\n        ({ response, inputTokens, outputTokens } = await this.callAnthropic(systemPrompt, userPrompt, screenshot));\n        break;\n      case VLMProvider.OPENAI:\n        ({ response, inputTokens, outputTokens } = await this.callOpenAI(systemPrompt, userPrompt, screenshot));\n        break;\n      case VLMProvider.VOLCENGINE:\n      case VLMProvider.DOUBAO:\n        ({ response, inputTokens, outputTokens } = await this.callVolcengine(systemPrompt, userPrompt, screenshot));\n        break;\n      case VLMProvider.CUSTOM:\n        ({ response, inputTokens, outputTokens } = await this.callCustom(systemPrompt, userPrompt, screenshot));\n        break;\n      default:\n        throw new Error(`Unsupported VLM provider: ${this.provider}`);\n    }\n\n    // Track cost\n    if (this.config.trackCost !== false) {\n      this.costTracker.track({\n        provider: this.provider,\n        model: this.model,\n        inputTokens,\n        outputTokens,\n        images: 1,\n        operation,\n      });\n    }\n\n    return response;\n  }\n\n  /**\n   * Call Anthropic Claude API\n   */\n  private async callAnthropic(\n    systemPrompt: string,\n    userPrompt: string,\n    screenshot: string\n  ): Promise<{ response: string; inputTokens: number; outputTokens: number }> {\n    const apiKey = this.config.apiKey || process.env.ANTHROPIC_API_KEY;\n    if (!apiKey) {\n      throw new Error('Anthropic API key not provided. Set ANTHROPIC_API_KEY or pass apiKey in config.');\n    }\n\n    const fetchResponse = await fetch('https://api.anthropic.com/v1/messages', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-api-key': apiKey,\n        'anthropic-version': '2023-06-01',\n      },\n      body: JSON.stringify({\n        model: this.model,\n        max_tokens: this.config.maxTokens || 4096,\n        system: systemPrompt,\n        messages: [\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'image',\n                source: {\n                  type: 'base64',\n                  media_type: 'image/jpeg',\n                  data: screenshot,\n                },\n              },\n              {\n                type: 'text',\n                text: userPrompt,\n              },\n            ],\n          },\n        ],\n      }),\n    });\n\n    if (!fetchResponse.ok) {\n      const error = await fetchResponse.text();\n      throw new Error(`Anthropic API error: ${error}`);\n    }\n\n    const data = await fetchResponse.json() as {\n      content: Array<{ text: string }>;\n      usage?: { input_tokens?: number; output_tokens?: number };\n    };\n    return {\n      response: data.content[0].text,\n      inputTokens: data.usage?.input_tokens || 1000,\n      outputTokens: data.usage?.output_tokens || 500,\n    };\n  }\n\n  /**\n   * Call OpenAI GPT-4V API\n   */\n  private async callOpenAI(\n    systemPrompt: string,\n    userPrompt: string,\n    screenshot: string\n  ): Promise<{ response: string; inputTokens: number; outputTokens: number }> {\n    const apiKey = this.config.apiKey || process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      throw new Error('OpenAI API key not provided. Set OPENAI_API_KEY or pass apiKey in config.');\n    }\n\n    const baseURL = this.config.baseURL || 'https://api.openai.com/v1';\n\n    const fetchResponse = await fetch(`${baseURL}/chat/completions`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${apiKey}`,\n      },\n      body: JSON.stringify({\n        model: this.model,\n        max_tokens: this.config.maxTokens || 4096,\n        messages: [\n          {\n            role: 'system',\n            content: systemPrompt,\n          },\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'image_url',\n                image_url: {\n                  url: `data:image/jpeg;base64,${screenshot}`,\n                },\n              },\n              {\n                type: 'text',\n                text: userPrompt,\n              },\n            ],\n          },\n        ],\n      }),\n    });\n\n    if (!fetchResponse.ok) {\n      const error = await fetchResponse.text();\n      throw new Error(`OpenAI API error: ${error}`);\n    }\n\n    const data = await fetchResponse.json() as {\n      choices: Array<{ message: { content: string } }>;\n      usage?: { prompt_tokens?: number; completion_tokens?: number };\n    };\n    return {\n      response: data.choices[0].message.content,\n      inputTokens: data.usage?.prompt_tokens || 1000,\n      outputTokens: data.usage?.completion_tokens || 500,\n    };\n  }\n\n  /**\n   * Call Volcengine (Doubao) API\n   */\n  private async callVolcengine(\n    systemPrompt: string,\n    userPrompt: string,\n    screenshot: string\n  ): Promise<{ response: string; inputTokens: number; outputTokens: number }> {\n    const apiKey = this.config.apiKey || process.env.VOLCENGINE_API_KEY || process.env.DOUBAO_API_KEY;\n    if (!apiKey) {\n      throw new Error('Volcengine API key not provided. Set VOLCENGINE_API_KEY or pass apiKey in config.');\n    }\n\n    const baseURL = this.config.baseURL || 'https://ark.cn-beijing.volces.com/api/v3';\n\n    const fetchResponse = await fetch(`${baseURL}/chat/completions`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${apiKey}`,\n      },\n      body: JSON.stringify({\n        model: this.model,\n        max_tokens: this.config.maxTokens || 4096,\n        messages: [\n          {\n            role: 'system',\n            content: systemPrompt,\n          },\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'image_url',\n                image_url: {\n                  url: `data:image/jpeg;base64,${screenshot}`,\n                },\n              },\n              {\n                type: 'text',\n                text: userPrompt,\n              },\n            ],\n          },\n        ],\n      }),\n    });\n\n    if (!fetchResponse.ok) {\n      const error = await fetchResponse.text();\n      throw new Error(`Volcengine API error: ${error}`);\n    }\n\n    const data = await fetchResponse.json() as {\n      choices: Array<{ message: { content: string } }>;\n      usage?: { prompt_tokens?: number; completion_tokens?: number };\n    };\n    return {\n      response: data.choices[0].message.content,\n      inputTokens: data.usage?.prompt_tokens || 1000,\n      outputTokens: data.usage?.completion_tokens || 500,\n    };\n  }\n\n  /**\n   * Call custom API (OpenAI-compatible)\n   */\n  private async callCustom(\n    systemPrompt: string,\n    userPrompt: string,\n    screenshot: string\n  ): Promise<{ response: string; inputTokens: number; outputTokens: number }> {\n    if (!this.config.baseURL) {\n      throw new Error('Custom provider requires baseURL');\n    }\n\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n    };\n\n    if (this.config.apiKey) {\n      headers['Authorization'] = `Bearer ${this.config.apiKey}`;\n    }\n\n    const fetchResponse = await fetch(`${this.config.baseURL}/chat/completions`, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify({\n        model: this.model,\n        max_tokens: this.config.maxTokens || 4096,\n        messages: [\n          {\n            role: 'system',\n            content: systemPrompt,\n          },\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'image_url',\n                image_url: {\n                  url: `data:image/jpeg;base64,${screenshot}`,\n                },\n              },\n              {\n                type: 'text',\n                text: userPrompt,\n              },\n            ],\n          },\n        ],\n      }),\n    });\n\n    if (!fetchResponse.ok) {\n      const error = await fetchResponse.text();\n      throw new Error(`Custom API error: ${error}`);\n    }\n\n    const data = await fetchResponse.json() as {\n      choices: Array<{ message: { content: string } }>;\n      usage?: { prompt_tokens?: number; completion_tokens?: number };\n    };\n    return {\n      response: data.choices[0].message.content,\n      inputTokens: data.usage?.prompt_tokens || 1000,\n      outputTokens: data.usage?.completion_tokens || 500,\n    };\n  }\n\n  /**\n   * Parse JSON from VLM response (handles markdown code blocks)\n   */\n  private parseJSON(text: string): Record<string, unknown> {\n    // Try direct parse first\n    try {\n      return JSON.parse(text);\n    } catch {\n      // Try extracting from markdown code block\n      const jsonMatch = text.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[1].trim());\n      }\n\n      // Try finding JSON object in text\n      const objectMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (objectMatch) {\n        return JSON.parse(objectMatch[0]);\n      }\n\n      throw new Error('Could not parse JSON from response');\n    }\n  }\n}\n"]}